# 健康检查
以为每个微服务必须为它自身的状态负责，所以每个微服务都应提供一个健康检查的接口。通过调用这个健康检查接口，外界可以判断这个服务的当前状态。一般情况下，并不是容器启动后容器中的应用就马上就绪了，应用一般还有一个启动或者初始化的过程。因此，必须有一种手段让平台检查微服务应用的就绪状态。

## 健康检查类别
健康检查分为两大类别：容器存活检查和容器就绪检查。
 + 容器存活检查：该检查方式用于检测容器是否存活，类似于我们执行 ps 命令检查进程是否存在。如果容器的存活检查失败，集群会对该容器执行重启操作；若容器的存活检查成功则不执行任何操作。 

 + 容器就绪检查：该检查方式用于检测容器是否准备好开始处理用户请求。一些程序的启动时间可能很长，比如要加载磁盘数据或者要依赖外部的某个模块启动完成才能提供服务。这时候程序进程在，但是并不能对外提供服务。这种场景下该检查方式就非常有用。如果容器的就绪检查失败，集群会屏蔽请求访问该容器；若检查成功，则会开放对该容器的访问。

## 健康检查方式

TCP 端口探测

TCP 端口探测的原理如下：
对于提供 TCP 通信服务的容器，集群周期性地对该容器建立 TCP 连接，如果连接成功，则证明探测成功，否则探测失败。选择 TCP 端口探测方式，必须指定容器监听的端口。比如我们有一个 redis 容器，它的服务端口是 6379，我们对该容器配置了 TCP 端口探测，指定探测端口为 6379，那么集群会周期性地对该容器的 6379 端口发起 TCP 连接，如果连接成功则证明检查成功，否则检查失败。

HTTP 请求探测

HTTP 请求探测针对的是提供 HTTP/HTTPS 服务的容器，集群周期性地对该容器发起 HTTP/HTTPS GET 请求，如果 HTTP/HTTPS response 返回码属于 200~399 范围，则证明探测成功，否则探测失败。使用 HTTP 请求探测必须指定容器监听的端口和 HTTP/HTTPS 的请求路径。
例如：提供 HTTP 服务的容器，服务端口为 80，HTTP 检查路径为 /health-check，那么集群会周期性地对容器发起如下请求：GET http://containerIP:80/health-check。
执行命令检查
执行命令检查是一种强大的检查方式，该方式要求用户指定一个容器内的可执行命令，集群会周期性地在容器内执行该命令，如果命令的返回结果是 0 则检查成功，否则检查失败。
对于上面提到的 TCP 端口探测和 HTTP 请求探测，都可以通过执行命令检查的方式来替代：
+ 对于 TCP 端口探测，我们可以写一个程序来对容器的端口进行 connect，如果 connect 成功，脚本返回 0，否则返回 -1。 
+ 对于 HTTP 请求探测，我们可以写一个脚本来对容器进行 wget
wget http://127.0.0.1:80/health-check
并检查 response 的返回码，如果返回码在 200~399 的范围，脚本返回 0，否则返回 -1。